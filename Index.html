<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfumer铆a Pro - Inventario y Ventas</title>
    
    <!-- Configuraci贸n PWA y M贸vil -->
    <meta name="theme-color" content="#1f2937">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Perfumer铆a Pro">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>Т</text></svg>">
    
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #111827; }
        html, body, #root { height: 100%; }
        /* Fix para PWA fullscreen en iOS */
        @media (display-mode: standalone) {
            .p-4 { padding-top: 2rem; }
        }
    </style>

    <!-- Carga de React, ReactDOM, Babel y Lucide Icons -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Carga de Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, updateDoc, deleteDoc, Timestamp, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Exponer Firebase SDKs globalmente
        window.firebase = { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, getFirestore, collection, onSnapshot, doc, setDoc, updateDoc, deleteDoc, Timestamp, addDoc };
    </script>
</head>
<body>
    <div id="root" class="min-h-screen"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;
        const { createRoot } = ReactDOM;
        
        // Obtener 铆conos de Lucide globalmente
        const { Plus, X, Search, ChevronUp, ChevronDown, Trash2, Archive, BarChart2, Download, Tag, Ruler } = lucide;

        // --- CONFIGURACIN DE FIREBASE: 隆IMPORTANTE! ---
        // DEBES reemplazar esta configuraci贸n por la de tu propio proyecto de Firebase.
        // 1. Crea un proyecto en Google Firebase.
        // 2. Habilita Firestore y Authentication (An贸nimo).
        // 3. Copia tu objeto de configuraci贸n y p茅galo aqu铆.
        const APP_ID_ROOT = "perfume-inventory-standalone"; // Ra铆z de la base de datos
        const firebaseConfig = {
            apiKey: "AIzaSyC_Your_Test_API_Key_HERE", // <--- REEMPLAZA ESTO
            authDomain: "your-project-id.firebaseapp.com", // <--- REEMPLAZA ESTO
            projectId: "your-project-id", // <--- REEMPLAZA ESTO
            storageBucket: "your-project-id.appspot.com", // <--- REEMPLAZA ESTO
            messagingSenderId: "123456789012", // <--- REEMPLAZA ESTO
            appId: "1:123456789012:web:abcdef1234567890abcdef" // <--- REEMPLAZA ESTO
        };

        let app, db, auth;

        // --- Funciones de Utilidad (para fechas) ---
        const getFifteenDaysAgo = () => {
            const date = new Date();
            date.setDate(date.getDate() - 15);
            return date.toISOString().split('T')[0];
        };
        
        const getToday = () => {
            return new Date().toISOString().split('T')[0];
        }

        // --- Componente Principal ---

        const App = () => {
            const [inventory, setInventory] = useState([]);
            const [salesLog, setSalesLog] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [dbInstance, setDbInstance] = useState(null);
            const [userId, setUserId] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [viewMode, setViewMode] = useState('inventory');
            
            // Estados del Modal y Reporte
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [productName, setProductName] = useState('');
            const [sku, setSku] = useState('');
            const [quantity, setQuantity] = useState(0);
            const [price, setPrice] = useState('');
            const [cost, setCost] = useState('');
            const [brand, setBrand] = useState('');
            const [mlSize, setMlSize] = useState('');
            const [searchTerm, setSearchTerm] = useState('');
            const [startDate, setStartDate] = useState(getFifteenDaysAgo());
            const [endDate, setEndDate] = useState(getToday());
            const [exportMessage, setExportMessage] = useState('');

            const { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, getFirestore, collection, onSnapshot, doc, setDoc, updateDoc, deleteDoc, Timestamp, addDoc } = window.firebase || {};

            // 1. Inicializaci贸n y Autenticaci贸n de Firebase
            useEffect(() => {
                if (!initializeApp) {
                    setError("Error: Las librer铆as de Firebase no se cargaron. Revisa la conexi贸n.");
                    setIsAuthReady(true);
                    return;
                }
                
                // Validaci贸n b谩sica de configuraci贸n
                if (firebaseConfig.apiKey.includes("YOUR")) {
                     setError("ATENCIN: Debes configurar tu propia API Key de Firebase para guardar datos.");
                     setIsAuthReady(true);
                     return;
                }

                try {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    setDbInstance(db);

                    const authenticate = async () => {
                        try {
                            // Usamos inicio de sesi贸n an贸nimo, ya que no hay token de inicio de sesi贸n
                            await signInAnonymously(auth);
                        } catch (authError) {
                            console.error("Error durante la autenticaci贸n:", authError);
                            setError("No se pudo conectar a la base de datos (Error de autenticaci贸n).");
                        }
                    };

                    const unsubscribe = onAuthStateChanged(auth, (user) => {
                        if (user) {
                            setUserId(user.uid);
                        } else {
                            setUserId(null);
                        }
                        setIsAuthReady(true);
                    });

                    authenticate();
                    return () => unsubscribe();

                } catch (e) {
                    console.error("Error al inicializar Firebase:", e);
                    setError("Fallo al inicializar Firebase. Revisa la configuraci贸n.");
                    setIsAuthReady(true);
                }
            }, []);

            // 2. Lectura de Inventario en tiempo real
            useEffect(() => {
                if (!isAuthReady || !userId || !dbInstance) return;

                setLoading(true);
                setError(null);

                // Ruta de la colecci贸n: /artifacts/{appId}/users/{userId}/perfume_inventory
                const collectionPath = `artifacts/${APP_ID_ROOT}/users/${userId}/perfume_inventory`;
                const invCollection = collection(dbInstance, collectionPath);

                const unsubscribe = onSnapshot(invCollection, (snapshot) => {
                    const items = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data(),
                        quantity: doc.data().quantity || 0,
                        price: doc.data().price || '0.00',
                        cost: doc.data().cost || '0.00',
                        brand: doc.data().brand || 'N/A',
                        mlSize: doc.data().mlSize || 'N/A',
                    }));
                    setInventory(items);
                    setLoading(false);
                }, (snapError) => {
                    console.error("Error en onSnapshot (Inventario):", snapError);
                    setError("Error al cargar el inventario: " + snapError.message);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [dbInstance, userId, isAuthReady]);

            // 3. Lectura de Log de Ventas en tiempo real
            useEffect(() => {
                if (!isAuthReady || !userId || !dbInstance) return;

                const salesCollectionPath = `artifacts/${APP_ID_ROOT}/users/${userId}/sales_log`;
                const salesCollection = collection(dbInstance, salesCollectionPath);

                const unsubscribe = onSnapshot(salesCollection, (snapshot) => {
                    const sales = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data(),
                        pricePerUnit: doc.data().pricePerUnit || 0,
                        costPerUnit: doc.data().costPerUnit || 0,
                        amountSold: doc.data().amountSold || 0,
                        totalSale: doc.data().totalSale || 0,
                        totalCost: doc.data().totalCost || 0,
                        saleDate: doc.data().saleDate ? doc.data().saleDate.toDate() : new Date(),
                    })).sort((a, b) => b.saleDate - a.saleDate);

                    setSalesLog(sales);
                }, (snapError) => {
                    console.error("Error en onSnapshot (Ventas):", snapError);
                });

                return () => unsubscribe();
            }, [dbInstance, userId, isAuthReady]);

            // --- Funciones CRUD y de Venta ---

            const resetModalState = () => {
                setProductName(''); setSku(''); setQuantity(0); setPrice(''); setCost(''); setBrand(''); setMlSize('');
                setIsModalOpen(false);
            };

            const handleAddProduct = async (e) => {
                e.preventDefault();
                if (!userId || !dbInstance) { setError("Base de datos no disponible."); return; }

                if (!productName || !sku || !brand || !mlSize || !price || !cost) {
                    setError("Todos los campos (Nombre, SKU, Marca, ML, Precio Venta y Costo) son obligatorios.");
                    return;
                }

                const salesPrice = parseFloat(price.replace(',', '.')).toFixed(2);
                const unitCost = parseFloat(cost.replace(',', '.')).toFixed(2);

                const newProduct = {
                    name: productName.trim(),
                    sku: sku.trim().toUpperCase(),
                    quantity: Math.max(0, parseInt(quantity, 10) || 0),
                    price: salesPrice,
                    cost: unitCost,
                    brand: brand.trim(),
                    mlSize: mlSize.trim(),
                    createdAt: Timestamp.now(),
                };

                try {
                    const docRef = doc(dbInstance, `artifacts/${APP_ID_ROOT}/users/${userId}/perfume_inventory`, newProduct.sku);
                    await setDoc(docRef, newProduct);
                    resetModalState();
                    setExportMessage("Producto a帽adido con 茅xito.");
                    setTimeout(() => setExportMessage(''), 3000);
                } catch (opError) {
                    console.error("Error al a帽adir producto:", opError);
                    setError("Fallo al a帽adir el producto: " + opError.message);
                }
            };

            const updateQuantity = useCallback(async (id, change) => {
                if (!userId || !dbInstance) return;

                try {
                    const docRef = doc(dbInstance, `artifacts/${APP_ID_ROOT}/users/${userId}/perfume_inventory`, id);
                    const currentItem = inventory.find(item => item.id === id);

                    if (currentItem) {
                        const currentQuantity = currentItem.quantity || 0;
                        const newQuantity = Math.max(0, currentQuantity + change);

                        await updateDoc(docRef, { quantity: newQuantity });

                        if (change < 0 && newQuantity < currentQuantity) {
                            const amountSold = Math.abs(change);
                            const salesCollectionPath = `artifacts/${APP_ID_ROOT}/users/${userId}/sales_log`;
                            const salesRef = collection(dbInstance, salesCollectionPath);
                            
                            const pricePerUnit = parseFloat(currentItem.price) || 0;
                            const costPerUnit = parseFloat(currentItem.cost) || 0;

                            const saleRecord = {
                                productId: id,
                                productName: currentItem.name,
                                productSku: currentItem.sku,
                                brand: currentItem.brand,
                                mlSize: currentItem.mlSize,
                                pricePerUnit: pricePerUnit,
                                costPerUnit: costPerUnit,
                                amountSold: amountSold,
                                totalSale: amountSold * pricePerUnit,
                                totalCost: amountSold * costPerUnit,
                                saleDate: Timestamp.now(),
                            };

                            await addDoc(salesRef, saleRecord);
                            setExportMessage(`Venta de ${amountSold} unidad(es) de ${currentItem.name} registrada.`);
                            setTimeout(() => setExportMessage(''), 3000);
                        }
                    }
                } catch (opError) {
                    console.error("Error al actualizar stock:", opError);
                    setError("Fallo al actualizar stock: " + opError.message);
                }
            }, [userId, dbInstance, inventory]);

            const deleteProduct = useCallback(async (id) => {
                if (!userId || !dbInstance) return;
                
                if (!window.confirm("驴Est谩s seguro de que quieres eliminar este producto? Esto no afectar谩 el log de ventas pasado.")) return;

                try {
                    const docRef = doc(dbInstance, `artifacts/${APP_ID_ROOT}/users/${userId}/perfume_inventory`, id);
                    await deleteDoc(docRef);
                    setExportMessage("Producto eliminado del inventario.");
                    setTimeout(() => setExportMessage(''), 3000);
                } catch (opError) {
                    console.error("Error al eliminar producto:", opError);
                    setError("Fallo al eliminar el producto: " + opError.message);
                }
            }, [userId, dbInstance]);

            // --- L贸gica de B煤squeda y Filtrado (omitiendo sub-componentes por espacio) ---
            const filteredInventory = useMemo(() => {
                if (!searchTerm) return inventory;
                const lowerCaseSearch = searchTerm.toLowerCase();
                return inventory
                    .filter(item =>
                        item.name.toLowerCase().includes(lowerCaseSearch) ||
                        item.sku.toLowerCase().includes(lowerCaseSearch) ||
                        item.brand.toLowerCase().includes(lowerCaseSearch)
                    )
                    .sort((a, b) => a.name.localeCompare(b.name));
            }, [inventory, searchTerm]);

            const totalStock = useMemo(() => {
                return inventory.reduce((sum, item) => sum + (item.quantity || 0), 0);
            }, [inventory]);

            // --- Funciones de Reporte CSV (omitiendo por espacio) ---
            const convertToCSV = (data, startDateObj, endDateObj) => {
                const filteredData = data.filter(sale => {
                    const date = sale.saleDate;
                    const adjustedEndDate = new Date(endDateObj);
                    adjustedEndDate.setDate(adjustedEndDate.getDate() + 1);
                    return date >= startDateObj && date < adjustedEndDate;
                });

                if (filteredData.length === 0) return null;

                const headers = ["Fecha", "Hora", "SKU", "Nombre", "Marca", "ML", "Unidades Vendidas", "Precio Unitario Venta ($)", "Costo Unitario ($)", "Ganancia Unitaria ($)", "Venta Total ($)", "Costo Total ($)", "GANANCIA NETA TOTAL ($)"];

                const rows = filteredData.map(sale => {
                    const unitProfit = (sale.pricePerUnit - sale.costPerUnit) || 0;
                    const netProfit = sale.totalSale - sale.totalCost;
                    
                    return [
                        sale.saleDate.toLocaleDateString('es-ES'),
                        sale.saleDate.toLocaleTimeString('es-ES', {hour: '2-digit', minute:'2-digit'}),
                        sale.productSku, sale.productName, sale.brand, sale.mlSize, sale.amountSold,
                        sale.pricePerUnit.toFixed(2), sale.costPerUnit.toFixed(2), unitProfit.toFixed(2),
                        sale.totalSale.toFixed(2), sale.totalCost.toFixed(2), netProfit.toFixed(2)
                    ].map(field => `"${field}"`).join(',');
                });

                return [headers.join(','), ...rows].join('\n');
            };

            const handleExport = () => {
                const start = new Date(startDate);
                const end = new Date(endDate);

                if (start > end) { setExportMessage("La fecha de inicio no puede ser posterior a la fecha de fin."); return; }

                const csvContent = convertToCSV(salesLog, start, end);

                if (!csvContent) { setExportMessage("No hay ventas registradas en el rango de fechas seleccionado."); return; }

                const fileName = `Reporte_Ganancias_Perfumes_${startDate}_a_${endDate}.csv`;
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", fileName);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                setExportMessage(`Reporte CSV "${fileName}" generado y descargado con 茅xito.`);
                setTimeout(() => setExportMessage(''), 5000);
            };

            // ... (AddProductModal, InventoryView, SalesLogView components are the same as before, condensed here) ...
            
            // --- Sub-Componentes (Mismo contenido que la respuesta anterior, adaptado a la sintaxis sin 'window.confirm') ---
            const AddProductModal = () => (
                <div className={`fixed inset-0 z-50 flex items-center justify-center p-4 transition-opacity duration-300 ${isModalOpen ? 'opacity-100 visible' : 'opacity-0 invisible'}`}>
                <div className="fixed inset-0 bg-black bg-opacity-70" onClick={resetModalState}></div>
                <div className="bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-md relative transform transition-transform duration-300 scale-100" onClick={(e) => e.stopPropagation()}>
                    <h2 className="text-2xl font-bold mb-4 text-pink-300">A帽adir Nuevo Perfume</h2>
                    <button onClick={resetModalState} className="absolute top-4 right-4 p-1 rounded-full text-gray-400 hover:text-white hover:bg-gray-700 transition" aria-label="Cerrar Modal"><X size={24} /></button>
                    <form onSubmit={handleAddProduct} className="space-y-4">
                        <div><label htmlFor="productName" className="block text-sm font-medium text-gray-300 mb-1">Nombre del Perfume</label>
                        <input id="productName" type="text" value={productName} onChange={(e) => setProductName(e.target.value)} required className="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg focus:border-pink-400 focus:ring-1 focus:ring-pink-400" placeholder="Ej: Eau de Luxe"/></div>
                        <div className="flex space-x-4">
                            <div className="w-1/2"><label htmlFor="brand" className="block text-sm font-medium text-gray-300 mb-1">Marca</label>
                            <input id="brand" type="text" value={brand} onChange={(e) => setBrand(e.target.value)} required className="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg focus:border-pink-400 focus:ring-1 focus:ring-pink-400" placeholder="Ej: Chanel"/></div>
                            <div className="w-1/2"><label htmlFor="mlSize" className="block text-sm font-medium text-gray-300 mb-1">ML (Tama帽o)</label>
                            <input id="mlSize" type="number" value={mlSize} onChange={(e) => setMlSize(e.target.value)} required min="1" className="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg focus:border-pink-400 focus:ring-1 focus:ring-pink-400" placeholder="Ej: 100"/></div>
                        </div>
                        <div><label htmlFor="sku" className="block text-sm font-medium text-gray-300 mb-1">SKU (C贸digo nico)</label>
                        <input id="sku" type="text" value={sku} onChange={(e) => setSku(e.target.value)} required className="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg focus:border-pink-400 focus:ring-1 focus:ring-pink-400" placeholder="Ej: LUXE001"/></div>
                        <div className="flex space-x-4">
                            <div className="w-1/2"><label htmlFor="price" className="block text-sm font-medium text-gray-300 mb-1">Precio Venta ($)</label>
                            <input id="price" type="text" value={price} onChange={(e) => setPrice(e.target.value.replace(/[^0-9.,]/g, ''))} required className="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg focus:border-pink-400 focus:ring-1 focus:ring-pink-400" placeholder="Ej: 89.99"/></div>
                            <div className="w-1/2"><label htmlFor="cost" className="block text-sm font-medium text-gray-300 mb-1">Costo Unitario ($)</label>
                            <input id="cost" type="text" value={cost} onChange={(e) => setCost(e.target.value.replace(/[^0-9.,]/g, ''))} required className="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg focus:border-pink-400 focus:ring-1 focus:ring-pink-400" placeholder="Ej: 45.00"/></div>
                        </div>
                        <div className="w-1/2"><label htmlFor="quantity" className="block text-sm font-medium text-gray-300 mb-1">Stock Inicial</label>
                        <input id="quantity" type="number" value={quantity} onChange={(e) => setQuantity(e.target.value)} min="0" className="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg focus:border-pink-400 focus:ring-1 focus:ring-pink-400"/></div>
                        <button type="submit" className="w-full py-3 mt-4 bg-pink-500 text-white font-semibold rounded-lg hover:bg-pink-600 transition duration-150 ease-in-out shadow-md">Guardar Perfume</button>
                    </form>
                </div>
                </div>
            );

            const ProductCard = ({ product }) => {
                const salePrice = parseFloat(product.price);
                const unitCost = parseFloat(product.cost);
                const profit = salePrice - unitCost;
                const isProfitPositive = profit >= 0;

                return (
                    <div className={`p-4 mb-3 rounded-xl shadow-lg transition duration-300 ease-in-out ${product.quantity <= 5 ? 'bg-red-900 border-red-700' : 'bg-gray-800 border-gray-700'} border hover:shadow-xl hover:border-pink-500/50 flex flex-col`}>
                        <div className="flex justify-between items-start mb-2">
                            <div className="min-w-0 flex-grow pr-2"><h3 className="text-xl font-semibold text-pink-300 truncate">{product.name}</h3>
                                <p className="text-xs text-gray-400 mb-1">SKU: <span className="font-mono text-gray-300">{product.sku}</span></p>
                            </div>
                            <div className="flex-shrink-0 text-right">
                                <div className="flex items-center text-sm text-gray-300"><Tag size={14} className="mr-1 text-pink-400" /><span className="font-medium">{product.brand}</span></div>
                                <div className="flex items-center text-sm text-gray-300 mt-1"><Ruler size={14} className="mr-1 text-pink-400" /><span className="font-medium">{product.mlSize} ML</span></div>
                            </div>
                        </div>
                        <div className="grid grid-cols-3 gap-2 my-2 py-2 border-y border-gray-700 text-center">
                            <div className="flex flex-col items-center"><p className="text-sm text-gray-400">Venta</p><span className="text-xl font-bold text-pink-400">${salePrice.toFixed(2)}</span></div>
                            <div className="flex flex-col items-center"><p className="text-sm text-gray-400">Costo</p><span className="text-xl font-bold text-gray-300">${unitCost.toFixed(2)}</span></div>
                            <div className="flex flex-col items-center"><p className="text-sm text-gray-400">Ganancia/Unid.</p>
                                <span className={`text-xl font-bold ${isProfitPositive ? 'text-green-400' : 'text-yellow-400'}`}>{isProfitPositive ? '+' : ''}${profit.toFixed(2)}</span>
                            </div>
                        </div>
                        <div className="flex justify-between items-center mt-3">
                            <div className="flex flex-col"><p className="text-lg text-white">Stock Actual:</p>
                                <span className={`text-3xl font-extrabold ${product.quantity <= 5 ? 'text-red-400' : 'text-white'}`}>{product.quantity}</span>
                            </div>
                            <div className="flex items-center space-x-3">
                                <div className="flex flex-col items-center">
                                    <button onClick={() => updateQuantity(product.id, 1)} className="p-1.5 bg-pink-500 hover:bg-pink-600 rounded-full transition" aria-label="Aumentar Stock"><ChevronUp size={16} className="text-white" /></button>
                                    <button onClick={() => updateQuantity(product.id, -1)} className="p-1.5 bg-gray-700 hover:bg-pink-600 rounded-full transition mt-2" aria-label="Disminuir Stock (Registrar Venta)" disabled={product.quantity <= 0}><ChevronDown size={16} className="text-white" /></button>
                                </div>
                                <button onClick={() => deleteProduct(product.id)} className="p-3 bg-gray-700 hover:bg-red-500 rounded-full transition ml-3 self-center" aria-label="Eliminar Producto"><Trash2 size={20} className="text-gray-300 hover:text-white" /></button>
                            </div>
                        </div>
                        {product.quantity <= 5 && (<p className="text-xs font-medium text-red-300 mt-2 text-center border-t border-red-700 pt-2">锔 隆Stock bajo! Quedan {product.quantity} unidades.</p>)}
                    </div>
                );
            };

            const InventoryView = () => (
                <>
                    <div className="relative mb-6">
                        <input type="text" placeholder="Buscar por Nombre, SKU o Marca..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full p-3 pl-10 rounded-lg bg-gray-700 text-white placeholder-gray-400 border border-gray-600 focus:border-pink-400 focus:ring-1 focus:ring-pink-400 transition"/>
                        <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" size={20} />
                    </div>
                    <div className="flex flex-col sm:flex-row gap-4 mb-6">
                        <div className="bg-gray-800 p-4 rounded-xl shadow-md flex-1 flex justify-between items-center border-l-4 border-pink-500"><p className="text-gray-300 font-medium">Productos Distintos:</p><p className="text-2xl font-bold text-pink-400">{inventory.length}</p></div>
                        <div className="bg-gray-800 p-4 rounded-xl shadow-md flex-1 flex justify-between items-center border-l-4 border-pink-500"><p className="text-gray-300 font-medium">Unidades Totales:</p><p className="text-2xl font-bold text-pink-400">{totalStock}</p></div>
                    </div>
                    {filteredInventory.length > 0 ? (
                        <div className="space-y-4">{filteredInventory.map(product => (<ProductCard key={product.id} product={product} />))}</div>
                    ) : (
                        <div className="text-center p-8 text-gray-400">No se encontraron productos con el t茅rmino "{searchTerm}".</div>
                    )}
                </>
            );
            
            const SalesLogView = () => {
                const totalRevenue = salesLog.reduce((sum, sale) => sum + (sale.totalSale || 0), 0);
                const totalCost = salesLog.reduce((sum, sale) => sum + (sale.totalCost || 0), 0);
                const totalNetProfit = totalRevenue - totalCost;

                const [transactionSearch, setTransactionSearch] = useState('');
                const filteredSales = salesLog.filter(sale => 
                    sale.productName.toLowerCase().includes(transactionSearch.toLowerCase()) ||
                    sale.productSku.toLowerCase().includes(transactionSearch.toLowerCase()) ||
                    sale.brand.toLowerCase().includes(transactionSearch.toLowerCase())
                );
                return (
                    <div className="space-y-6">
                        <h2 className="text-2xl font-bold text-pink-300">Generaci贸n de Reportes</h2>
                        <div className="bg-gray-800 p-4 rounded-xl shadow-md">
                            <p className="text-sm font-medium text-gray-300 mb-3">Selecciona el rango para el reporte de ganancias</p>
                            <div className="flex flex-col sm:flex-row gap-4 mb-4">
                                <div className="flex-1"><label htmlFor="startDate" className="block text-sm font-medium text-gray-300 mb-1">Desde</label>
                                <input id="startDate" type="date" value={startDate} onChange={(e) => setStartDate(e.target.value)} className="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg focus:border-pink-400"/></div>
                                <div className="flex-1"><label htmlFor="endDate" className="block text-sm font-medium text-gray-300 mb-1">Hasta</label>
                                <input id="endDate" type="date" value={endDate} onChange={(e) => setEndDate(e.target.value)} className="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg focus:border-pink-400"/></div>
                            </div>
                            <button onClick={handleExport} className="w-full py-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition duration-150 ease-in-out flex items-center justify-center shadow-md">
                                <Download size={20} className="mr-2" />Descargar Reporte de Ganancias CSV
                            </button>
                        </div>
                        <h2 className="text-2xl font-bold text-pink-300 mt-8">Resumen y Log de Transacciones</h2>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div className="bg-gray-800 p-4 rounded-xl shadow-md flex justify-between items-center border-l-4 border-pink-500"><p className="text-gray-300 font-medium text-sm">Venta Total (Hist贸rico):</p><p className="text-xl font-bold text-pink-400">${totalRevenue.toFixed(2)}</p></div>
                            <div className="bg-gray-800 p-4 rounded-xl shadow-md flex justify-between items-center border-l-4 border-gray-500"><p className="text-gray-300 font-medium text-sm">Costo Total (Hist贸rico):</p><p className="text-xl font-bold text-gray-300">${totalCost.toFixed(2)}</p></div>
                            <div className="bg-gray-800 p-4 rounded-xl shadow-md flex justify-between items-center border-l-4 border-green-500"><p className="text-gray-300 font-medium text-sm">Ganancia Neta (Hist贸rica):</p><p className="text-xl font-bold text-green-400">${totalNetProfit.toFixed(2)}</p></div>
                        </div>
                        <div className="relative">
                            <input type="text" placeholder="Filtrar transacciones por nombre, SKU o marca..." value={transactionSearch} onChange={(e) => setTransactionSearch(e.target.value)} className="w-full p-3 pl-10 rounded-lg bg-gray-700 text-white placeholder-gray-400 border border-gray-600 focus:border-pink-400 focus:ring-1 focus:ring-pink-400 transition"/>
                            <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" size={20} />
                        </div>
                        {filteredSales.length === 0 ? (<div className="text-center p-8 text-gray-400 border border-dashed border-gray-700 rounded-xl">No hay transacciones que coincidan con el filtro.</div>) : (
                            <div className="space-y-3">
                                {filteredSales.map((sale) => {
                                    const netProfit = sale.totalSale - sale.totalCost;
                                    return (
                                        <div key={sale.id} className="bg-gray-700 p-4 rounded-lg shadow-inner flex justify-between items-center">
                                            <div className="flex flex-col min-w-0 flex-grow pr-4">
                                                <span className="font-semibold text-white truncate">{sale.productName}</span>
                                                <span className="text-xs text-gray-500 mt-1">{sale.saleDate.toLocaleString('es-ES')}</span>
                                            </div>
                                            <div className="text-right flex-shrink-0">
                                                <span className="text-sm text-gray-400 block">Venta: <span className="text-pink-300 font-bold">${sale.totalSale.toFixed(2)}</span></span>
                                                <span className="text-sm text-gray-400 block">Costo: <span className="text-gray-300 font-bold">${sale.totalCost.toFixed(2)}</span></span>
                                                <span className="text-lg font-bold block mt-1" style={{ color: netProfit > 0 ? '#48bb78' : '#f6e05e' }}>Ganancia: ${netProfit.toFixed(2)}</span>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                );
            };
            
            const Header = () => (
                <div className="bg-gray-800 shadow-lg sticky top-0 z-10">
                <div className="p-4 flex justify-between items-center">
                    <h1 className="text-2xl font-bold text-pink-300">Perfumer铆a Pro</h1>
                    {viewMode === 'inventory' && (
                        <button onClick={() => setIsModalOpen(true)} className="p-3 bg-pink-500 hover:bg-pink-600 rounded-full shadow-lg transition duration-150 ease-in-out flex items-center" aria-label="A帽adir Producto">
                            <Plus size={24} className="text-white" />
                        </button>
                    )}
                </div>
                <div className="flex border-b border-gray-700">
                    <TabButton mode="inventory" icon={Archive} label="Inventario" />
                    <TabButton mode="sales" icon={BarChart2} label="Reporte de Ganancias" />
                </div>
                </div>
            );
            
            const TabButton = ({ mode, icon: Icon, label }) => (
                <button onClick={() => setViewMode(mode)} className={`flex-1 p-3 flex items-center justify-center space-x-2 rounded-t-lg transition-colors duration-200 ${
                    viewMode === mode ? 'bg-gray-700 text-pink-300 font-semibold border-b-2 border-pink-500' : 'bg-gray-800 text-gray-400 hover:bg-gray-700 hover:text-white'}`}>
                <Icon size={20} />
                <span className="hidden sm:inline">{label}</span>
                </button>
            );

            return (
                <div className="min-h-screen bg-gray-900 font-sans">
                <Header />
                <div className="max-w-4xl mx-auto p-4 pt-6">
                    
                    {(error || exportMessage) && (
                        <div className={`p-4 mb-4 rounded-lg font-medium transition duration-300 ${error ? 'text-red-100 bg-red-700' : 'text-green-100 bg-green-600'}`}>
                            {error ? <strong>Error:</strong> : <strong>Estado:</strong>} {error || exportMessage}
                        </div>
                    )}

                    <p className="text-xs text-gray-500 mb-4 text-center">
                        {userId ? `ID Sesi贸n: ${userId} (Comparte este ID si quieres el mismo inventario en otro m贸vil)` : 'Autenticando...'}
                    </p>

                    {loading && inventory.length === 0 && (
                    <div className="text-center p-8">
                        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-pink-400 mx-auto"></div>
                        <p className="mt-4 text-gray-300">Conectando a base de datos...</p>
                    </div>
                    )}
                    
                    {!loading && (
                        <>
                            {viewMode === 'inventory' && <InventoryView />}
                            {viewMode === 'sales' && <SalesLogView />}
                        </>
                    )}

                    {isModalOpen && <AddProductModal />}

                </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>
</body>
</html>

